---
title: "Choosing an atlas"
author: "Martin Westgate, Dax Kellie"
date: '2023-10-13'
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Choosing an atlas}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
resource_files:
  - '../man/figures/atlases_plot.png'
---



The GBIF network consists of a series of a series of 'node' organisations who
collate biodiversity data from their own countries, with GBIF acting as an 
umbrella organisation to store data from all nodes. Several nodes have their 
own APIs, often built from the 'living atlas' codebase developed by the ALA.
At present, `galah` supports the following functions and atlases:


<img src="../man/figures/atlases_plot.png" alt="plot of chunk atlas-support" width="100%" />


## Set Organisation

Set which atlas you want to use by changing the `atlas` argument in 
`galah_config()`. The `atlas` argument can accept a full name, an acronym, or a 
region to select a given atlas, all of which are available via `show_all(atlases)`. 
Once a value is provided, it will automatically update `galah`'s server 
configuration to your selected atlas. The default `atlas` is Australia.

If you intend to download records, you may need to register a user profile with 
the relevant atlas first. 


```r
galah_config(atlas = "GBIF.es", email = "your_email_here")
```

## Look up Information

You can use the same look-up functions to find useful information about the 
Atlas you have set. Available information may vary for each Living Atlas.


```r
galah_config(atlas = "Guatemala")
```

```
## Atlas selected: Sistema Nacional de Información sobre Diversidad Biológica de Guatemala (SNIBgt) [Guatemala]
```

```r
show_all(datasets)
```

```
## # A tibble: 1,283 × 3
##    id     name                                                                                                                         uri  
##    <chr>  <chr>                                                                                                                        <chr>
##  1 dr1440 A catalogue of the Heteroptera (Hemiptera) or true bugs of Argentina                                                         http…
##  2 dr1436 A cybercatalogue of American sand fly types (Diptera, Psychodidae, Phlebotominae) deposited at the Natural History Museum, … http…
##  3 dr1226 A distinctive new species of biting midge in the subgenus Euprojoannisia Brèthes from Mexico with new records of Neotropica… http…
##  4 dr321  A Distribution and Taxonomic Reference Dataset of Geranium (Geraniaceae) in the New World                                    http…
##  5 dr1285 A geographic distribution database of the cassava whitefly complex (Hemiptera, Aleyrodidae) and their associated parasitoid… http…
##  6 dr12   A global database for the distributions of crop wild relatives                                                               http…
##  7 dr467  A matrix-based revision of the genus Hypogena Dejean, 1834 (Coleoptera Tenebrionidae)                                        http…
##  8 dr1061 A Monographic Revision of the Genus Hoplopyga Thomson, 1880 (Coleoptera: Scarabaeidae: Cetoniinae: Gymnetini)                http…
##  9 dr1570 A new Anomiopus Westwood (Coleoptera: Scarabaeidae: Scarabaeinae) from the Mayan Biosphere Reserve, Petén, Guatemala         http…
## 10 dr1177 A new Central American genus of pleasing fungus beetles (Coleoptera: Erotylidae) from the Ischyrus-Megischyrus complex       http…
## # ℹ 1,273 more rows
```

```r
show_all(fields)
```

```
## # A tibble: 128 × 3
##    id                   description        type  
##    <chr>                <chr>              <chr> 
##  1 all_image_url        <NA>               fields
##  2 assertion_user_id    Assertions by user fields
##  3 assertions           Record issues      fields
##  4 assertions_missing   <NA>               fields
##  5 assertions_passed    <NA>               fields
##  6 assertions_unchecked <NA>               fields
##  7 basis_of_record      Record type        fields
##  8 catalogue_number     Catalogue Number   fields
##  9 cl10011              <NA>               fields
## 10 class                Class              fields
## # ℹ 118 more rows
```

```r
search_all(fields, "year")
```

```
## # A tibble: 2 × 3
##   id              description      type  
##   <chr>           <chr>            <chr> 
## 1 year            Year             fields
## 2 occurrence_year Date (by decade) fields
```

```r
search_taxa("lagomorpha")
```

```
## # A tibble: 1 × 8
##   search_term scientific_name taxon_concept_id rank  kingdom  phylum   class    order     
##   <chr>       <chr>           <chr>            <chr> <chr>    <chr>    <chr>    <chr>     
## 1 lagomorpha  Lagomorpha      785              order Animalia Chordata Mammalia Lagomorpha
```

## Download data

You can build queries as you normally would in `galah`. For taxonomic 
queries, use `search_taxa()` to make sure your searches are 
returning the correct taxonomic data.


```r
galah_config(atlas = "United Kingdom")
```

```
## Atlas selected: National Biodiversity Network (NBN) [United Kingdom]
```

```r
search_taxa("vlps")   # Returns no data due to misspelling
```

```
## Error in `filter()`:
## ℹ In argument: `!duplicated(guid)`.
## Caused by error:
## ! object 'guid' not found
```

```r
search_taxa("vulpes") # Returns data
```

```
## # A tibble: 1 × 12
##   search_term scientific_name scientific_name_authorship taxon_concept_id rank  kingdom  phylum   class    order     family genus superclass
##   <chr>       <chr>           <chr>                      <chr>            <chr> <chr>    <chr>    <chr>    <chr>     <chr>  <chr> <chr>     
## 1 vulpes      Vulpes          Frisch, 1775               NBNSYS0000138878 genus Animalia Chordata Mammalia Carnivora Canid… Vulp… Tetrapoda
```

```r
galah_call() |>
  galah_identify("vulpes") |>
  galah_filter(year > 2010) |>
  atlas_counts()
```

```
## # A tibble: 1 × 1
##    count
##    <int>
## 1 124909
```

Download species occurrence records from other atlases with 
`atlas_occurrences()`


```r
galah_config(atlas = "Guatemala")
```

```
## Atlas selected: Sistema Nacional de Información sobre Diversidad Biológica de Guatemala (SNIBgt) [Guatemala]
```

```r
galah_call() |>
  galah_identify("Lagomorpha") |>
  galah_filter(year <= 1980) |>
  galah_select(taxon_name, year) |>
  atlas_occurrences()
```

```
## # A tibble: 4 × 3
##   recordID                             scientificName                   year
##   <chr>                                <chr>                           <dbl>
## 1 d4e64dc9-f30c-432a-b026-dd1d9325817c Aellopos titan Burmeister, 1856  1971
## 2 219121ad-67b9-450c-9b30-c7dce84b30d6 Erinnyis ello subsp. ello        1973
## 3 c6675471-e3e3-49bb-8526-a573b14d9dd7 Manduca rustica Fabricius, 1775  1930
## 4 633e26ac-d144-408d-b829-4ac8aba14f7c Manduca rustica Fabricius, 1775  1930
```


# Complex queries with multiple Atlases

It is also possible to create more complex queries that return data from 
multiple Living Atlases. As an example, setting atlases within a loop with 
`galah_config()` and `purrr::map()` allows us to return the total number of 
species records in each Living Atlas in one table.


```r
library(purrr)
library(tibble)
library(dplyr)
library(gt)

atlases <- show_all(atlases)

counts <- map(atlases$region, 
  function(x){
    galah_config(atlas = x)
    atlas_counts()
})
```

```
## Error in `map()`:
## ℹ In index: 6.
## Caused by error in `check_fields()`:
## ! Can't use fields that don't exist.
## ℹ Use `search_all(fields)` to find a valid field ID.
## ✖ Can't find field(s) in
##   • `galah_filter()`: taxonKey
```

```r
tibble(
  atlas = atlases$region, 
  n = unlist(counts)) |> 
  filter(n > 0) |>
  arrange(desc(n)) |>
  gt() |>
  fmt_number(column = n)
```

```
## Error: object 'counts' not found
```

