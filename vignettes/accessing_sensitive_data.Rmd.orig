---
title: "Accessing sensitive data"
author: "Martin Westgate"
date: "2025-10-29"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Accessing sensitive data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r, include = FALSE}
galah_config(atlas = "Australia", verbose = FALSE)
```

`galah` provides access to biodiversity information stored by GBIF and its' 
partner nodes. While much of this information is shared freely and without 
restriction, there are a number of cases where this is not appropriate, such
as the locations of:

 - threatened species, whose locations are protected by law in many jurisdictions
 - species at risk from poachers, particularly for wildlife trade

This leads to a problem: data that is more open helps scientists and policy-makers
understand and conserve biodiversity, but also generates threats to those 
species. To balance these concerns against one another, it is common to 
'obfuscate' sensitive data, which consists of providing location information
at a lower spatial resolution, making it harder to locate threatened species on
the ground.

# How ALA handles sensitive data

While many data providers solve this problem themselves in a range of ways - 
such as by not sharing data at all, randomising some locations, or reducing 
the number of decimal places of their locations - others provide high-precision
data on the understanding that it will only be made available to specific users,
and then only by written agreement. In these cases, the ALA displays the 
obfuscated data publicly, but retains the original data for use for specific 
purposes. Researchers can request access to the original data via the National 
Framework for the Sharing of Restricted Access Species Data in Australia, more 
simply known as the 'RASD framework' (https://www.rasd.org.au). 

If your access to sensitive data is approved by the provider(s) in question,
from version 2.2.0 you can use 'galah' to access that sensitive data. 

# Switching on authentication

You have three options for setting authentication in galah. In practice, each of
these calls the versions below it.

The ideal way to set authentication is to call `authenticate()`. This checks for 
and caches `show_all_config()`, which contains the information necessary to 
run an authentication pipeline. It then triggers a dummy query which, in turn,
opens a browser window to open for you to enter credentials. Once authentication
is achieved, default behaviour is applied, namely caching only for:

- occurrence downloads
- query uploads
- (species list uploads?)

An alternative is to call `galah_config(authenticate = TRUE)`. This will 
establish default authentication behaviour, but won't open a browser until 
a query is run that requires authentication.

The *final* way to set up authentication is to call it in-pipe with 
`use_authentication()`. This is called internally by the above functions, and
amends a `_request` object to add a `authenticate` slot.
When this slot exists, a query to `show_all_config()` is included by 
`coalesce()` and executed by `collapse()`. The benefit of this function is it 
allows overruling of package defaults for authentication.


# Keeping emails and passwords secure

First, you will need to add your email address and password, as usual for
downloads via `galah`. Because you might want to share your script at some 
point, we do not recommend that you simply type these into your script. Instead,
if you save your information in json format, you can import it directly to 
R without ever showing the text in your script. For example, if you save this 
text into a file:

```{r, eval = FALSE}
{"email":"my.email@email.com", "password":"the-most-secure-password-ever"}
```

Then, if we import this from JSON to a list, we can pass it directly to 
`galah_config()` without typing secret information into our script. 

```{r, eval = FALSE}
jsonlite::fromJSON("my_secret_information.txt") |>
  galah_config()
```

The second step is to switch on authentication, also via `galah_config()`. 
This downloads a client ID and set of URLs from the ALA that enable 
authentication, and also triggers later queries to run an authentication process.

```{r, eval = FALSE}
galah_config(authenticate = TRUE)
```

That's it! What happens next is that your first query will trigger your browser
to open. Once you have successfully signed in to the ALA, later queries will
have the full set of permissions available to you via `galah`.

# Deciding what sensitive data to access

In the the ALA, sensitive data are stored in bespoke fields, which have an
existing field name prefixed with `sensitive_`. They cannot be requested 
directly. Instead, if you request a field that has a sensitive counterpart, both 
the public and sensitive version of that field will be returned.

```{r, echo = FALSE}
library(gt)
library(tibble)

fields <- c("eventID", "eventDate",
            "eventTime", "month", "day",
            "locality", "locationRemarks",
            "decimalLatitude", "decimalLongitude",
            "footprintWKT",
            "verbatimEventDate", "verbatimLocality",
            "verbatimCoordinates", "verbatimLatitude",
            "verbatimLongitude")
tibble::tibble(public_field = fields,
               restricted_field = glue::glue("sensitive_{fields}")) |>
               gt::gt() |>
               gt::cols_align(align = "left")
```


So to download data, we might try something like:

```
result <- galah_call() |>
    filter(species_list_uid == "dr491") |>
    collect()

> result
# A tibble: 487 × 12
   recordID   scientificName taxonConceptID decimalLatitude sensitive_decimalLat…¹ decimalLongitude
   <chr>      <chr>          <chr>                    <dbl>                  <dbl>            <dbl>
 1 00825ab0-… Caladenia vul… https://id.bi…           -37.8                     NA             145.
 2 0094e7df-… Caladenia vul… https://id.bi…           -37.7                     NA             141.
 3 00d3a4e3-… Caladenia vul… https://id.bi…           -39.6                     NA             147.
 4 02305849-… Caladenia vul… https://id.bi…           -38.0                     NA             145.
 5 02e28dc1-… Caladenia vul… https://id.bi…           -37.7                     NA             145.
 6 068b4c68-… Caladenia vul… https://id.bi…           -37.7                     NA             141.
 7 07b5356b-… Caladenia vul… https://id.bi…           -37.0                     NA             143.
 8 0807fcbe-… Caladenia vul… https://id.bi…           -37.9                     NA             145.
 9 093df7f4-… Caladenia vul… https://id.bi…           -37.9                     NA             145.
10 0942b709-… Caladenia vul… https://id.bi…           -38.4                     NA             145.
# ℹ 477 more rows
# ℹ abbreviated name: ¹​sensitive_decimalLatitude
# ℹ 6 more variables: sensitive_decimalLongitude <dbl>, eventDate <dttm>,
#   sensitive_eventDate <lgl>, basisOfRecord <chr>, occurrenceStatus <chr>, dataResourceName <chr>
# ℹ Use `print(n = ...)` to see more rows

> colnames(result)
 [1] "recordID"                   "scientificName"             "taxonConceptID"            
 [4] "decimalLatitude"            "sensitive_decimalLatitude"  "decimalLongitude"          
 [7] "sensitive_decimalLongitude" "eventDate"                  "sensitive_eventDate"       
[10] "basisOfRecord"              "occurrenceStatus"           "dataResourceName" 
```