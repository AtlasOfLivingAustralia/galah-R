---
title: "Package design"
author: "Dax Kellie & Martin Westgate"
date: "20/12/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
vignette: >
  %\VignetteIndexEntry{Package design}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
  
Functions in `galah` are designed according to a nested architecture. Users
that require data should begin by locating the relevant `atlas_` function, 
which determines the type of data that will be downloaded 
(see [downloading data section](#Download-data)). 
Users can then filter their data queries with filtering functions like 
`search_taxa` and the [`galah_` functions](#Filter-data). The specific fields 
and values that users can filter their data by can be found using `show_all_`, or 
`find_` functions. 

This nested architecture allows a method of step-by-step filtering prior to 
downloading data. To make this easier, as of `galah` 1.4.0, 
data queries can also be built using piping syntax (e.g., `%>%` or `|>`) by first 
using the `galah_call()` function (see the `vignette("taxonomic_information")`). 

For a better view of the relationships between functions in `galah`, here is a 
diagram of how they all link together:



<img src="galah-DiagrammeR-plot.png" title="plot of function relationships" alt="plot of function relationships" width="100%" />





## `galah_` functions

Functions that alter or filter data requests use the prefix `galah_`. They include:

-   `galah_filter`
-   `galah_select`
-   `galah_group_by`
-   `galah_geolocate`
-   `galah_down_to`

These functions replace or extend functions previously prefixed by `select_`. 
Renaming `select_` functions to `galah_` functions reflects `galah`'s embrace of
`dplyr`. This new embrace can be seen in the names of `galah_` functions; they echo 
`dplyr`'s `filter`, `select` and `group_by` functions.

The similarity of `galah_` functions to `dplyr` doesn't end there. `galah_filter`, 
`galah_select` and `galah_group_by` also use `dplyr` tidy evaluation and syntax. 
This means that the way you use `dplyr` functions is also how you use `galah_` 
functions.

Let's look at a few examples to show you what we mean.

Use `galah_filter` to filter the rows of queries:


```r
# Get total record count since 2000
atlas_counts(filter = galah_filter(year > 2000))
```

```
## # A tibble: 1 × 1
##      count
##      <int>
## 1 62834053
```

```r
# Get total record count for iNaturalist in 2021
atlas_counts(
  filter = galah_filter(year == 2021,
                        dataResourceName == "iNaturalist Australia"))
```

```
## # A tibble: 1 × 1
##    count
##    <int>
## 1 940050
```

Use `galah_group_by` to group record counts and summarise counts by specified fields:


```r
# Get record counts since 2010, grouped by year and basis of record
galah_config(verbose = FALSE)
atlas_counts(
  filter = galah_filter(year > 2015 & year <= 2020),
  group_by = galah_group_by(year, basisOfRecord, expand = TRUE)
  )
```

```
## # A tibble: 35 × 3
##    year  basisOfRecord         count
##    <chr> <chr>                 <int>
##  1 2020  HUMAN_OBSERVATION   5820506
##  2 2020  PRESERVED_SPECIMEN    13637
##  3 2020  OBSERVATION            2863
##  4 2020  UNKNOWN                 365
##  5 2020  MATERIAL_SAMPLE         250
##  6 2020  LIVING_SPECIMEN         127
##  7 2020  MACHINE_OBSERVATION      37
##  8 2019  HUMAN_OBSERVATION   5399921
##  9 2019  UNKNOWN               51747
## 10 2019  PRESERVED_SPECIMEN    38117
## # … with 25 more rows
```

Use `galah_select` to choose which columns are returned when downloading records:


```r
# Get records from 1930, but only 'eventDate' and 'kingdom' columns
atlas_occurrences(
  filter = galah_filter(year == 1930),
  select = galah_select(eventDate, kingdom)
  ) |>
  head() # only return first 5 lines
```

Use `galah_geolocate` to specify a geographic area or region to limit your search:


```r
# Get list of perameles species only in area specified:
# (Note: This can also be specified by a shapefile)
wkt <- "POLYGON((131.36328125 -22.506468769126,135.23046875 -23.396716654542,134.17578125 -27.287832521411,127.40820312499 -26.661206402316,128.111328125 -21.037340349154,131.36328125 -22.506468769126))"

species <- atlas_species(geolocate = galah_geolocate(wkt))
```

Use `galah_down_to` to specify the lowest taxonomic level to contruct a taxonomic 
tree:


```r
atlas_taxonomy(taxa = search_taxa("fungi"),
               galah_down_to(phylum))
```

`galah_` functions also evaluate arguments just like `dplyr`. To see what we mean, 
let's look at an example of how `dplyr::filter()` works. Notice how `dplyr::filter` 
and `galah_filter` both require logical arguments to be added by using the `==` sign:


```r
library(dplyr)

mtcars %>% filter(mpg == 21)
```

```
##               mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4      21   6  160 110  3.9 2.620 16.46  0  1    4    4
## Mazda RX4 Wag  21   6  160 110  3.9 2.875 17.02  0  1    4    4
```


```r
atlas_counts(filter = galah_filter(year == 2021))
```

```
## # A tibble: 1 × 1
##     count
##     <int>
## 1 1154055
```

As another example, notice how `galah_group_by` works very similarly to
 `dplyr::group_by` + `dplyr::count()`:


```r
mtcars %>% 
  group_by(vs) %>% 
  count()
```

```
## # A tibble: 2 × 2
## # Groups:   vs [2]
##      vs     n
##   <dbl> <int>
## 1     0    18
## 2     1    14
```

```r
atlas_counts(group_by = galah_group_by(biome))
```

```
## # A tibble: 2 × 2
##   biome          count
##   <chr>          <int>
## 1 TERRESTRIAL 93413775
## 2 MARINE       3519441
```


We made this move towards tidy evaluation to make it possible to use 
piping for building queries to the Atlas of Living Australia. In practice, this 
means that data queries can be filtered just like how you might 
filter a `data.frame` with the `tidyverse` suite of functions. 
To learn how, see the [Piping with `galah_call`] section.


## `search_taxa` & `find_taxa`

`search_taxa` and `find_taxa` replace the previously named `select_taxa`.  
  
`search_taxa` now does what most people used `select_taxa for most often, and 
this its new name is intended to reflect the function's use - 
it searches for taxonomic information. `search_taxa` uses fuzzy matching to work 
a lot like the search bar on the [Atlas of Living Australia website](https://bie-ws.ala.org.au/), 
and you can use it to search for taxa by name. Finding your desired taxa with 
`search_taxa` is an important step to using this taxonomic information to download 
data with `galah`.  
  
For example, to search for reptiles, we first need to identify whether we have 
the correct query and verify using additional taxonomic information:


```r
search_taxa("Reptilia")
```

```
## # A tibble: 1 × 9
##   search_term scientific_name taxon_concept_id                           rank  match_type kingdom  phylum  class  issues
##   <chr>       <chr>           <chr>                                      <chr> <chr>      <chr>    <chr>   <chr>  <chr> 
## 1 Reptilia    REPTILIA        urn:lsid:biodiversity.org.au:afd.taxon:68… class exactMatch Animalia Chorda… Repti… noIss…
```

The output confirms that *Reptilia* is the correct search term, which we can use 
in `atlas_` functions to narrow our results or records. Furthermore, the output 
we get from `search_taxa` is consistent with the other `search_` function, 
`search_fields`.

Alternatively, `find_taxa` replaces the previous ability of `select_taxa` to use 
unique identifiers to identify taxa. `find_taxa` only accepts identifiers and, 
unlike `search_taxa`, cannot be used to filter data queries:


```r
find_taxa("https://id.biodiversity.org.au/node/apni/2914510")
```

```
## # A tibble: 1 × 13
##   scientific_name     scientific_name… taxon_concept_id rank  match_type kingdom phylum class order family genus species
##   <chr>               <chr>            <chr>            <chr> <chr>      <chr>   <chr>  <chr> <chr> <chr>  <chr> <chr>  
## 1 Eucalyptus blakelyi Maiden           https://id.biod… spec… taxonIdMa… Plantae Charo… Equi… Myrt… Myrta… Euca… Eucaly…
## # … with 1 more variable: issues <chr>
```

Instead, to use `find_taxa` results to filter queries, you can nest them 
within `search_taxa`:


```r
taxa <- find_taxa("https://id.biodiversity.org.au/node/apni/2914510")
atlas_counts(taxa = search_taxa(taxa))
```

```
## # A tibble: 1 × 1
##     count
##     <int>
## 1 1112798
```

## `atlas_` functions

The prefix `atlas_` replaces `ala_` for the functions

-   `atlas_counts`
-   `atlas_occurrences`
-   `atlas_species`
-   `atlas_media`
-   `atlas_taxonomy`
-   `atlas_citation`

This change was made to reflect the ability for functions like `atlas_counts` and 
`atlas_occurrences` to use international atlases since `galah` 1.2.0 
(see `vignette("international_atlases")`).

`atlas_` functions work the same as previous `ala_` functions, but with changes 
to the names of arguments they accept. Argument names are consistent with the 
functions that they use. With the new syntax of `galah_` functions and the 
update to `search_taxa`, these argument changes look like this:


```r
# Get species list for Perameles (aka Bandicoots)
atlas_species(taxa = search_taxa("perameles"))

# Get record counts of Perameles by year since 2010
atlas_counts(taxa = search_taxa("perameles"),
             filter = galah_filter(year > 2010),
             group_by = galah_group_by (year))

# Get records of Perameles from 2010, with "basis of record" included as a column
atlas_occurrences(taxa = search_taxa("perameles"),
                  filter = galah_filter(year == 2010),
                  select = galah_select(basisOfRecord, group = "basic"),
                  geolocate = wkt) # wkt was defined in earlier example

# Get taxonomic tree of Peramelemorphia (aka bandicoots & bilbies) down to genus
atlas_taxonomy(taxa = search_taxa("Peramelemorphia"),
               down_to = galah_down_to("genus"))

# Download media of Regent Honeyeater from 2010
atlas_media(taxa = search_taxa("Regent Honeyeater"),
            filter = galah_filter(year == 2010),
            download_dir = "media")
```

See R help files for more information on using `atlas_` functions with updated syntax.


## `show_all_` functions

Functions with the prefix `show_all_` return a `data.frame` doing exactly that 
- showing all the possible values of the category specified. These functions include:

-   `show_all_fields`
-   `show_all_atlases`
-   `show_all_ranks`
-   `show_all_profiles`
-   `show_all_reasons`
-   `show_all_cached_files`

`show_all_` functions require no arguments. Simply call the function and it will 
return all accepted values:


```r
show_all_atlases()
```

```
## # A tibble: 6 × 3
##   atlas     taxonomy_source taxonomy_info                                                    
##   <chr>     <chr>           <chr>                                                            
## 1 Australia ALA             https://bie.ala.org.au/                                          
## 2 Austria   GBIF            https://www.gbif.org/dataset/d7dddbf4-2cf0-4f39-9b2a-bb099caae36c
## 3 Guatemala GBIF            https://www.gbif.org/dataset/d7dddbf4-2cf0-4f39-9b2a-bb099caae36c
## 4 Spain     GBIF            https://www.gbif.org/dataset/d7dddbf4-2cf0-4f39-9b2a-bb099caae36c
## 5 Sweden    GBIF            https://www.gbif.org/dataset/d7dddbf4-2cf0-4f39-9b2a-bb099caae36c
## 6 UK        NBN             https://www.nhm.ac.uk/our-science/data/uk-species.html
```

```r
show_all_reasons()
```

```
## # A tibble: 13 × 2
##       id name                            
##    <int> <chr>                           
##  1     0 conservation management/planning
##  2     1 biosecurity management/planning 
##  3     2 environmental assessment        
##  4     3 education                       
##  5     4 scientific research             
##  6     5 collection management           
##  7     6 other                           
##  8     7 ecological research             
##  9     8 systematic research/taxonomy    
## 10    10 testing                         
## 11    11 citizen science                 
## 12    12 restoration/remediation         
## 13    13 species modelling
```

# Piping with `galah_call()`

All of these syntax changes towards tidy evaluation now make it possible to use 
pipes (i.e., `|>` or `%>%`) to build queries to the Atlas of Living Australia. 
In practice, this means that you can now build queries like how you would 
filter or wrangle a `data.frame` using `dplyr`.  
  
In order to use piping, you must use the `galah_call()` function. Let's 
look at an examples:


```r
# Find number of records of bandicoot species in 2021
# With piping
galah_call() %>%
  search_taxa("perameles") %>%
  galah_filter(year == 2021) %>%
  galah_group_by(species, year) %>%
  atlas_counts()
```

```
## # A tibble: 2 × 3
##   year  species          count
##   <chr> <chr>            <int>
## 1 2021  Perameles nasuta   510
## 2 2021  Perameles gunnii    49
```
This is equivalent to:


```r
# Without piping
atlas_counts(taxa = search_taxa("perameles"),
             filter = galah_filter(year == 2001),
             group_by = galah_group_by(species, year))
```

And a second example:


```r
# Download occurrence records of bandicoots in 2021, with coordinates
# With piping
galah_call() %>%
  search_taxa("perameles") %>%
  galah_filter(year == 2021) %>%
  galah_select(group = "basic", ZERO_COORDINATE) %>%
  atlas_occurrences()
```
This is equivalent to:


```r
# Without piping
atlas_occurrences(taxa = search_taxa("perameles"),
                  filter = galah_filter(year == 2001),
                  select = galah_select(group = "basic", ZERO_COORDINATE))
```

Beginning a query with `galah_call()` (be sure to add the parentheses!) tells 
`galah` that you will be using pipes to construct your query. Follow this with 
your preferred pipe (`|>` from `base` or `%>%` from `magrittr`). You can then 
narrow your query with line-by-line using `galah_` functions or the `search_taxa` 
function. Finally, end with an `atlas_` function to identify what type of data
you want from your query.  
  
Importantly, piping only works with revamped syntax. We hope that users who 
prefer `tidyverse` syntax will find this change useful and exciting!


# Deprecated syntax

Before version 1.4.0, galah had an entirely different architecture.

Old syntax will now return a warning message when used that suggests users the 
new syntax. 

New syntax changes are by no means set in stone - it is absolutely possible to 
change syntax in future versions of `galah` if alternative names are easier to 
use and understand. We would appreciate any feedback from users about what works 
or what doesn't work. It is our goal to create a package that is as easy and 
intuitive for users as possible!



```
## Error: <text>:12:3: unexpected string constant
## 11:     
## 12:   "select_filters"
##       ^
```
