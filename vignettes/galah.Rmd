---
title: "galah"
author: "Matilda Stevenson"
date: '2021-12-22'
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{galah}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



# About
`galah` is an R interface to biodiversity data hosted by the 
[Atlas of Living Australia](https://ala.org.au) (ALA). The ALA is a repository 
of biodiversity data, focussed primarily on observations of individual life forms. 
Like the Global Biodiversity Information Facility ([GBIF](https://www.gbif.org)), 
the basic unit of data at ALA is an **occurrence** record, based on the 
['Darwin Core'](https://dwc.tdwg.org) data standard.

`galah` enables users to locate and download species observations, taxonomic
information, or associated media such images or sounds, and to restrict their
queries to particular taxa or locations. Users can specify which columns are
returned by a query, or restrict their results to observations that meet
particular quality-control criteria. All functions return a `data.frame` as
their standard format.

Functions in `galah` are designed according to a nested architecture. Users
that require data should begin by locating the relevant `atlas_` function (see
[downloading data section](#downloading-data)); the arguments within that
function then call correspondingly-named [`galah_` functions](#filtering-data);
and finally the specific values that can be interpreted by those `galah_`
functions are given by `search_`, `show_all_`, or `find_` functions. The
relationships between these functions are as follows:



<img src="galah-DiagrammeR-plot.png" title="plot of function relationships" alt="plot of function relationships" width="100%" />

## Installation

Install from CRAN:

```r
install.packages("galah")
```

Install the development version from GitHub:

```r
install.packages("remotes")
remotes::install_github("AtlasOfLivingAustralia/galah")
```

See the [README](https://github.com/AtlasOfLivingAustralia/galah/blob/master/README.md) for system requirements.

Load the package

```r
library(galah)
galah_config(atlas = "Australia") # This is the default atlas
```

# Filtering data

Each occurrence record contains taxonomic information, and also some
information about the observation itself, such as its location and the date
of the observation. Each piece of information associated with a
given occurrence is stored in a **field**,  which corresponds to a **column**
when imported to a `data.frame`.

Data fields are important because they provide a means to *filter*
occurrence records;  i.e. to return only the information that you need, and
no more. Consequently, much of the architecture of `galah` has been
designed to make filtering as simple as possible, by using functions with the
`galah_` prefix.

## Taxonomic filtering
`search_taxa()` enables users search for taxonomic names and check the results
are 'correct' before using the result to download data.
The function allows both free-text searches and searches where the rank(s) are
specified. Specifying the rank can be useful when names are ambiguous.

```r
# free text search
taxa_filter <- search_taxa("Eolophus")

# specifying ranks
search_taxa(query = list(genus = "Eolophus", kingdom = "Aves"))
```

```
##   search_term scientific_name scientific_name_authorship
## 1    Eolophus        Eolophus            Bonaparte, 1854
## 2        Aves            AVES                       <NA>
##                                                              taxon_concept_id  rank match_type  kingdom   phylum class
## 1 urn:lsid:biodiversity.org.au:afd.taxon:b2de5e40-df8f-4339-827d-25e63454a4a2 genus exactMatch Animalia Chordata  Aves
## 2 urn:lsid:biodiversity.org.au:afd.taxon:5ed80139-31bb-48a8-9f57-42d8015dacbb class exactMatch Animalia Chordata  Aves
##            order     family    genus  issues vernacular_name
## 1 Psittaciformes Cacatuidae Eolophus noIssue            <NA>
## 2           <NA>       <NA>     <NA> noIssue           Birds
```

For more detailed taxonomic information use `search_taxonomy()`, as outlined in 
`vignette("taxonomic_information")`

## Location-based filtering
Users can provide an `sf` object or a Well-Known Text (WKT) string for
location-based filtering.

```r
locations <- galah_geolocate(query = st_read('act_rect.shp'))
```

## Field based filtering
As mentioned above, all occurrence records in the ALA contain additional
information about the record, stored in **fields**. Field-based filters are
specified with `galah_filter()`, which takes individual filters, in the form
`field logical value`, and/or a [data quality profile](#data-quality-profiles).

To find available fields and corresponding valid values, field lookup 
functions are provided. For finding field names, use `search_fields()`, for
finding valid field values, use `find_field_values()`.

```r
search_fields("basis")
```

```
##                                                  id
## 12                                    basisOfRecord
## 189                               raw_basisOfRecord
## 670                         BASIS_OF_RECORD_INVALID
## 735 OCCURRENCE_STATUS_INFERRED_FROM_BASIS_OF_RECORD
##                                                                                                      description
## 12  What this is a record of e.g. specimen, human observation, fossil http://rs.tdwg.org/dwc/terms/basisOfRecord
## 189     The basis of record as supplied by the data publisher http://rs.tdwg.org/dwc/terms/verbatimBasisOfRecord
## 670                                                                                 Basis of record badly formed
## 735                                                              Occurrence status inferred from basis of record
##           type link
## 12      fields <NA>
## 189     fields <NA>
## 670 assertions <NA>
## 735 assertions <NA>
```

```r
field_values <- find_field_values("basisOfRecord")
```
Build a field filter


```r
filters <- galah_filter(basisOfRecord == "HumanObservation")
```

It is also possible to pass other kinds of logical statement to
`galah_filter()`.

```r
filters <- galah_filter(basisOfRecord == "HumanObservation",
                          year >= 2010,
                          occurrenceStatus != "absent")
```


### Data quality profiles
A notable extention of the filtering approach is to remove records with low
'quality'. ALA performs quality control checks on all records that it stores.
These checks are used to generate new fields, that can then be used to filter
out records that are unsuitable for particular applications. However, there
are many possible data quality checks, and it is not always clear which are
most appropriate in a given instance. Therefore, `galah` supports ALA
data quality **profiles**, which can be passed to `galah_filter()`to quickly
remove undesirable records. A full list of data quality profiles is returned by
`find_profiles()`.


```r
profiles <- show_all_profiles()
```
View filters included in a profile

```r
find_profile_attributes("ALA")
```

```
## # A tibble: 23 × 2
##    description                                                                          filter                          
##    <chr>                                                                                <chr>                           
##  1 "Exclude all records where spatial validity is \"false\""                            "-spatiallyValid:\"false\""     
##  2 "Exclude all records with an assertion that the scientific name provided does not m… "-assertions:TAXON_MATCH_NONE"  
##  3 "Exclude all records with an assertion that the scientific name provided is not str… "-assertions:INVALID_SCIENTIFIC…
##  4 "Exclude all records with an assertion that the name and classification supplied ca… "-assertions:TAXON_HOMONYM"     
##  5 "Exclude all records with an assertion that kingdom provided doesn't match a known … "-assertions:UNKNOWN_KINGDOM"   
##  6 "Exclude all records with an assertion that the scientific name provided in the rec… "-assertions:TAXON_SCOPE_MISMAT…
##  7 "Exclude all records with an assertion of the occurence is cultivated or escaped fr… "-establishmentMeans:\"MANAGED\…
##  8 "Exclude all records with an assertion of latitude value provided is zero"           "-decimalLatitude:0"            
##  9 "Exclude all records with an assertion of longitude value provided is zero"          "-decimalLongitude:0"           
## 10 "Exclude all records with an assertion of  latitude and longitude have been transpo… "-assertions:\"PRESUMED_SWAPPED…
## # … with 13 more rows
```
Include a profile in the filters

```r
filters <- galah_filter(basisOfRecord == "HumanObservation",
                          profile = "ALA")
```

# Downloading data

Functions that return data from ALA are named with the prefix `atlas_`,
followed by a suffix describing the information that they provide.

By combining different filter functions, it is possible to build complex
queries to return only the most valuable information for a given problem.
Once you have retrieved taxon information, you can use this to [search for
occurrence records](#occurrence-data) with `atlas_occurrences()`. However, it is
also possible to [download data on species](#species-data) via `atlas_species()`,
or [media content](#media_downloads) (largely images) via `atlas_media()`.
Alternatively, users can [retrieve record counts](#record-counts) using `atlas_counts()`.

## Occurrence data

In addition to the [filter functions](#filtering-data) above, when downloading
occurrence data users can specify which columns are returned using
`galah_select()`. Individual column names and/or column groups can be
specified.
To view the fields for each group, see the documentation for `galah_select()`.
To view the list of available fields, run `search_fields()`.

```r
cols <- galah_select("institutionID", group = "basic")
```

To download occurrence data you will need to specify your email in
`galah_config()`. This email must be associated with an active ALA account. See
more information in the [config section](#config)



```r
galah_config(email = your_email_here, atlas = "Australia")
```

Download occurrence records for *Eolophus roseicapilla*

```r
occ <- atlas_occurrences(taxa = search_taxa("Eolophus roseicapilla"),
                       filter = galah_filter(stateProvince == "Australian Capital Territory",
                                                year >= 2010,
                                                profile = "ALA"),
                       select = galah_select("institutionID", group = "basic"))
```


```r
head(occ)
```

```
## # A tibble: 6 × 8
##   decimalLatitude decimalLongitude eventDate  scientificName  taxonConceptID    recordID  dataResourceName institutionID
##             <dbl>            <dbl> <chr>      <chr>           <chr>             <chr>     <chr>            <chr>        
## 1           -35.9             149. ""         Eolophus rosei… urn:lsid:biodive… 17f46d49… eBird Australia  ""           
## 2           -35.9             149. ""         Eolophus rosei… urn:lsid:biodive… ef2b9066… eBird Australia  ""           
## 3           -35.9             149. "2012-01-… Eolophus rosei… urn:lsid:biodive… 4f7cd714… BirdLife Austra… ""           
## 4           -35.9             149. ""         Eolophus rosei… urn:lsid:biodive… 3236c470… eBird Australia  ""           
## 5           -35.8             149. ""         Eolophus rosei… urn:lsid:biodive… eec91d83… eBird Australia  ""           
## 6           -35.8             149. ""         Eolophus rosei… urn:lsid:biodive… e340c423… eBird Australia  ""
```

## Species data
A common use case of the ALA is to identify which species occur in a specified
region, time period, or taxonomic group. `atlas_species()` enables the user to 
look up this information, using the common set of filter functions.



```r
# List rodent species in the NT
species <- atlas_species(taxa = search_taxa("Rodentia"),
            filter = galah_filter(stateProvince == "Northern Territory"))
head(species)
```

```
##    kingdom   phylum    class    order  family        genus                     species            author
## 1 Animalia Chordata Mammalia Rodentia Muridae Mesembriomys        Mesembriomys gouldii (J.E. Gray, 1843)
## 2 Animalia Chordata Mammalia Rodentia Muridae      Zyzomys             Zyzomys argurus    (Thomas, 1889)
## 3 Animalia Chordata Mammalia Rodentia Muridae    Pseudomys Pseudomys hermannsburgensis     (Waite, 1896)
## 4 Animalia Chordata Mammalia Rodentia Muridae      Notomys              Notomys alexis      Thomas, 1922
## 5 Animalia Chordata Mammalia Rodentia Muridae      Melomys             Melomys burtoni    (Ramsay, 1887)
## 6 Animalia Chordata Mammalia Rodentia Muridae          Mus                Mus musculus    Linnaeus, 1758
##                                                                  species_guid        vernacular_name
## 1 urn:lsid:biodiversity.org.au:afd.taxon:f38bcd7e-ae6a-4734-bd64-06995bc230eb  Black-footed Tree-rat
## 2 urn:lsid:biodiversity.org.au:afd.taxon:46611113-a1e3-45b1-b58c-7aef088a9da7        Common Rock-rat
## 3 urn:lsid:biodiversity.org.au:afd.taxon:5d73fc2f-3caa-4b44-aa40-3711e8304f80     Sandy Inland Mouse
## 4 urn:lsid:biodiversity.org.au:afd.taxon:49001532-929e-4b78-97d3-c885e97d671b Spinifex Hopping-mouse
## 5 urn:lsid:biodiversity.org.au:afd.taxon:89dfa41e-2c5a-44d1-80bf-8d4cd3c73089      Grassland Melomys
## 6 urn:lsid:biodiversity.org.au:afd.taxon:107696b5-063c-4c09-a015-6edfdb6f4d52            House Mouse
```

## Record counts
`atlas_counts()` provides summary counts on records in the ALA, without needing
to download all the records. In addition to the filter arguments, it has an
optional `group_by` argument, which provides counts binned by the requested
field.

```r
# Total number of records in the ALA
atlas_counts()
```

```
## [1] 101744937
```

```r
# Total number of records, broken down by kindgom
atlas_counts(group_by = galah_group_by(kingdom))
```

```
##      kingdom    count
## 1   Animalia 76204190
## 2    Plantae 21779977
## 3      Fungi  1891039
## 4  Chromista   915012
## 5   Protista    67348
## 6   Bacteria    58148
## 7   Protozoa    23468
## 8    Archaea     1103
## 9  Eukaryota      735
## 10     Virus      465
```


## Media downloads
In addition to text data describing individual occurrences and their attributes, 
ALA stores images, sounds and videos associated with a given record. These can 
be downloaded to `R` using `atlas_media()` and the same set of filters as the 
other data download functions.


```r
# Use the occurrences previously downloaded
media_data <- atlas_media(
     taxa = search_taxa("Eolophus roseicapilla"),
     filter = galah_filter(year == 2020),
     download_dir = "media")
```


# Config
Various aspects of the galah package can be customized. To preserve
configuration for future sessions, set `profile_path` to a location of a
`.Rprofile` file.

## Email
To download occurrence records, you will need to provide an email address
registered with the ALA. You can create an account [here](https://auth.ala.org.au/userdetails/registration/createAccount).
Once an email is registered with the ALA, it should be stored in the config:

```r
galah_config(email = "myemail@gmail.com")
```

## Caching
`galah` can cache most results to local files. This means that if the same code
is run multiple times, the second and subsequent iterations will be faster.

By default, this caching is session-based, meaning that the local files are
stored in a temporary directory that is automatically deleted when the R
session is ended. This behaviour can be altered so that caching is permanent,
by setting the caching directory to a non-temporary location.


```r
galah_config(cache_directory = "example/dir")
```

By default, caching is turned off. To turn caching on, run

```r
galah_config(caching = FALSE)
```


## Debugging
If things aren't working as expected, more detail (particularly about web 
requests and caching behaviour) can be obtained by setting the `verbose` 
configuration option:


```r
galah_config(verbose = TRUE)
```

## Setting the download reason
ALA requires that you provide a reason when downloading occurrence data 
(via the galah `atlas_occurrences()` function). The reason is set as 
"scientific research" by default, but you can change this using `galah_config()`. 
See `show_all_reasons()` for valid download reasons.


```r
galah_config(download_reason_id = your_reason_id)
```
