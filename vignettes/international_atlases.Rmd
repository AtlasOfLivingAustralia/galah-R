---
title: "International Atlases"
author: "Martin Westgate, Dax Kellie"
date: '2022-10-13'
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{International Atlases}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



The architecture developed by the ALA to store biodiversity data is used by over
20 International Living Atlases. Although there are slight differences in the 
core components of each Atlas's architecture, `galah` is flexible enough to 
handle most of these differences. As a result, it is possible to change which 
Living Atlas you get data from in `galah` 


## Supported Atlases

To see which international Living Atlases `galah` currently supports, use  
`show_all_atlases()`.


```r
library(galah)
show_all_atlases()
```

```
## # A tibble: 11 × 4
##    atlas          institution                                                             acronym url                         
##    <chr>          <chr>                                                                   <chr>   <chr>                       
##  1 Australia      Atlas of Living Australia                                               ALA     https://www.ala.org.au      
##  2 Austria        Biodiversitäts-Atlas Österreich                                         BAO     https://biodiversityatlas.at
##  3 Brazil         Sistemas de Informações sobre a Biodiversidade Brasileira               SiBBr   https://sibbr.gov.br        
##  4 Canada         Candensys                                                               <NA>    http://www.canadensys.net   
##  5 Estonia        eElurikkus                                                              <NA>    https://elurikkus.ee        
##  6 France         Inventaire National du Patrimoine Naturel                               INPN    https://inpn.mnhn.fr        
##  7 Guatemala      Sistema Nacional de Información sobre Diversidad Biológica de Guatemala SNIBgt  https://snib.conap.gob.gt   
##  8 Portugal       GBIF Portugal                                                           GBIF.pt https://www.gbif.pt         
##  9 Spain          GBIF Spain                                                              GBIF.es https://www.gbif.es         
## 10 Sweden         Swedish Biodiversity Data Infrastructure                                SBDI    https://biodiversitydata.se 
## 11 United Kingdom National Biodiversity Network                                           NBN     https://nbn.org.uk
```

Some atlases support more types of data queries than others (e.g. counts, 
occurrences, species lists). To see what kinds of information and data can be 
returned from each atlase, you can see the list of supported Application 
Programming Interfaces (APIs).


```r
show_all_apis()
```

```
## # A tibble: 179 × 5
##   atlas     system       api_name                api_url                                                      called_by           
##   <chr>     <chr>        <chr>                   <chr>                                                        <chr>               
## 1 Australia collections  collections_collections https://collections.ala.org.au/ws/collection                 show_all_collections
## 2 Australia collections  collections_datasets    https://collections.ala.org.au/ws/dataResource               show_all_datasets   
## 3 Australia collections  collections_providers   https://collections.ala.org.au/ws/dataProvider               show_all_providers  
## 4 Australia data-quality profiles_all            https://data-quality-service.ala.org.au/api/v1/data-profiles show_all_profiles   
## # … with 175 more rows
```

## Set Atlas

Set which atlas you want to use by changing the `atlas` argument in 
`galah_config()`. This will automatically update `galah`'s server configuration 
to your selected Atlas. The default `atlas` is Australia.

If you intend to download records, you may need to register a user profile with 
the relevant Atlas first. 


```r
galah_config(atlas = "Spain", email = "your_email_here")
```

## Look up Information

You can use the same look-up functions to find useful information about the 
Atlas you have set. Available information may vary for each Living Atlas.


```r
galah_config(atlas = "Guatemala")

show_all_datasets()
```

```
## # A tibble: 522 × 3
##   name                                                                                                                                                      uri   uid  
##   <chr>                                                                                                                                                     <chr> <chr>
## 1 A Distribution and Taxonomic Reference Dataset of Geranium (Geraniaceae) in the New World                                                                 http… dr321
## 2 A global database for the distributions of crop wild relatives                                                                                            http… dr12 
## 3 A matrix-based revision of the genus Hypogena Dejean, 1834 (Coleoptera Tenebrionidae)                                                                     http… dr467
## 4 A new Mexican species of Chrysina Kirby (Coleoptera: Scarabaeidae: Rutelinae), with nomenclatural changes, new records, and a key to the C. quiche speci… http… dr554
## # … with 518 more rows
```

```r
show_all_fields()
```

```
## # A tibble: 129 × 4
##   id                 description                                                                                        type   link 
##   <chr>              <chr>                                                                                              <chr>  <chr>
## 1 all_image_url      Image URLs for this record                                                                         fields <NA> 
## 2 assertion_user_id  User ID of the person who has made an assertion about this record                                  fields <NA> 
## 3 assertions         A list of all assertions (user and system supplied) for a record resulting from data quality tests fields <NA> 
## 4 assertions_missing Assertion indicating missing field values for a record. E.g. missing basis of record               fields <NA> 
## # … with 125 more rows
```

```r
search_fields("year")
```

```
## # A tibble: 3 × 4
##   id              description                                                                                                              type   link 
##   <chr>           <chr>                                                                                                                    <chr>  <chr>
## 1 year            http://rs.tdwg.org/dwc/terms/year                                                                                        fields <NA> 
## 2 occurrence_year Year ranges for a search. Calculated based on the unique values for a query.                                             fields <NA> 
## 3 date_precision  The precision of the date information for the record. Values include 'Day', 'Month', 'Year', 'Year range', 'Month range' fields <NA>
```

```r
search_taxa("lagomorpha")
```

```
## # A tibble: 1 × 12
##   search_term taxon_concept_id scientific_name             scientific_name_authorship rank    kingdom  phylum     class   order   family        genus           species
##   <chr>       <chr>            <chr>                       <chr>                      <chr>   <chr>    <chr>      <chr>   <chr>   <chr>         <chr>           <chr>  
## 1 lagomorpha  1561720          Scaptodrosophila lagomorpha (Okada & Carson, 1982)     species Animalia Arthropoda Insecta Diptera Drosophilidae Scaptodrosophi… Scapto…
```


## Download data

You can build queries as you normally would in `galah`. For taxonomic 
queries, use `search_taxa()` to make sure your searches are 
returning the correct taxonomic data.


```r
galah_config(atlas = "Canada")

search_taxa("vlps")   # Returns no data due to misspelling
```

```
## # A tibble: 1 × 2
##   search_term match_type
##   <chr>       <chr>     
## 1 vlps        NONE
```

```r
search_taxa("vulpes") # Returns data
```

```
## # A tibble: 1 × 13
##   search_term taxon_concept_id scientific_name     canonical_name rank  status   match_type kingdom  phylum   order     family  genus  class   
##   <chr>                  <int> <chr>               <chr>          <chr> <chr>    <chr>      <chr>    <chr>    <chr>     <chr>   <chr>  <chr>   
## 1 vulpes               5219234 Vulpes Frisch, 1775 Vulpes         GENUS ACCEPTED EXACT      Animalia Chordata Carnivora Canidae Vulpes Mammalia
```

```r
galah_call() |>
  galah_identify("vulpes") |>
  galah_filter(year > 2010) |>
  atlas_counts()
```

```
## # A tibble: 1 × 1
##   count
##   <int>
## 1    10
```

Download species occurrence records from other atlases with 
`atlas_occurrences()`


```r
galah_config(atlas = "Guatemala")

galah_call() |>
  galah_identify("Lagomorpha") |>
  galah_filter(year <= 1980) |>
  galah_select(taxon_name, year) |>
  atlas_occurrences()
```

```
## Error:
## ! This query does not match any records.
```


# Complex queries with multiple Atlases

It is also possible to create more complex queries that return data from 
multiple Living Atlases. As an example, setting atlases within a loop with 
`galah_config()` and `purrr::map()` allows us to return the total number of 
species records in each Living Atlas in one table.


```r
library(purrr)
library(tibble)
library(dplyr)
library(gt)

atlases <- show_all_atlases()

counts <- map(atlases$atlas, 
  function(x){
    galah_config(atlas = x)
    atlas_counts()
})

tibble(
  atlas = atlases$atlas, 
  n = unlist(counts)) |> 
  arrange(desc(n)) |>
  gt() |> 
  gt::fmt_number(columns = round(n, 0))
```

```
## Error in `round()`:
## ! non-numeric argument to mathematical function
```

