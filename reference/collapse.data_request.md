# Generate a query

Constructs a query so it can be inspected before being sent.
[`collapse()`](https://dplyr.tidyverse.org/reference/compute.html) can
be called at the end of a pipe that begins with
[`galah_call()`](https://galah.ala.org.au/R/reference/galah_call.md) to
return the constructed user query generated by the user's data request
(a `query` object). Objects of class `data_request` (created using
[`request_data()`](https://galah.ala.org.au/R/reference/galah_call.md)),
`metadata_request` (from
[`request_metadata()`](https://galah.ala.org.au/R/reference/galah_call.md))
or `files_request` (from
[`request_files()`](https://galah.ala.org.au/R/reference/galah_call.md))
are all supported.

## Usage

``` r
# S3 method for class 'data_request'
collapse(x, ...)

# S3 method for class 'metadata_request'
collapse(x, ...)

# S3 method for class 'files_request'
collapse(x, ...)

# S3 method for class 'prequery'
collapse(x, ...)

# S3 method for class 'query'
collapse(x, ...)

# S3 method for class 'query_set'
collapse(x, ...)
```

## Arguments

- x:

  An object to run
  [`collapse()`](https://dplyr.tidyverse.org/reference/compute.html) on.
  Classes supported by `galah` include `data_request`,
  `metadata_request` and `files_request` for building queries; and
  `prequery`, `query` or `query_set` once constructed (via
  [`capture()`](https://galah.ala.org.au/R/reference/capture.data_request.md)
  or [`compound()`](https://galah.ala.org.au/R/reference/compound.md)).

- ...:

  Arguments passed on to
  [`capture()`](https://galah.ala.org.au/R/reference/capture.data_request.md).

## Value

An object of class `query`, which is a list-like object containing two
or more of the following slots:

- `type`: The type of query, serves as a lookup to the corresponding
  field in `show_all(apis)`

- `url`: Either:

  - a length-1 character giving the API to be queried; or

  - a `tibble` containing at least the field `url` and optionally others

- `headers`: headers to be sent with the API call

- `body`: body section of the API call

- `options`: options section of the API call

- `request`: captures the supplied `_request` object (see
  [`galah_call()`](https://galah.ala.org.au/R/reference/galah_call.md))

## Details

`galah` uses an object-based pipeline to convert piped requests into
valid queries, and to enact those queries with the specified
organisation. Typically, requests open with
[`galah_call()`](https://galah.ala.org.au/R/reference/galah_call.md) -
though
[`request_metadata()`](https://galah.ala.org.au/R/reference/galah_call.md)
and
[`request_files()`](https://galah.ala.org.au/R/reference/galah_call.md)
are also valid - and end with
[`collect()`](https://galah.ala.org.au/R/reference/collect.data_request.md).
Under the hood, the sequence of functions is as follows:

[`capture()`](https://galah.ala.org.au/R/reference/capture.data_request.md)
→ [`compound()`](https://galah.ala.org.au/R/reference/compound.md) →
[`collapse()`](https://dplyr.tidyverse.org/reference/compute.html) →
[`compute()`](https://galah.ala.org.au/R/reference/compute.data_request.md)
→
[`collect()`](https://galah.ala.org.au/R/reference/collect.data_request.md)

[`collapse()`](https://dplyr.tidyverse.org/reference/compute.html)
constructs a complete user query, ready to be sent by
[`compute()`](https://galah.ala.org.au/R/reference/compute.data_request.md).
Information required to construct a complete user query are provided by
[`capture()`](https://galah.ala.org.au/R/reference/capture.data_request.md)
and [`compound()`](https://galah.ala.org.au/R/reference/compound.md),
preceding functions to parse and combine all required API calls
necessary to build a user's query.

## See also

To open a piped query, see
[`galah_call()`](https://galah.ala.org.au/R/reference/galah_call.md).
For alternative operations on `_request` objects, see
[`capture()`](https://galah.ala.org.au/R/reference/capture.data_request.md),
[`compound()`](https://galah.ala.org.au/R/reference/compound.md),
[`compute()`](https://galah.ala.org.au/R/reference/compute.data_request.md)
or
[`collect()`](https://galah.ala.org.au/R/reference/collect.data_request.md).
