#' Non-generic tidyverse functions
#' 
#' Several useful functions from `{tidyverse}` packages are `generic`, meaning
#' that we can define class-specific versions of those functions and implement
#' them in galah; examples include `filter()`, `select()` and `group_by()`.
#' However, there are also functions that are only defined within tidyverse 
#' packages and are not generic. In a few cases we have re-implemented these 
#' functions in `galah`. This has the consequence of supporting consistent
#' syntax with tidyverse, at the cost of potentially introducing conflicts.
#' This can be avoided by using the `::` operator where required (see examples).
#' 
#' The following functions are included:
#'  - `desc()` (`dplyr`): use within `arrange()` to specify arrangement should be descending
#'  - `unnest()` (`tidyr`): use to 'drill down' into nested information on `fields`, `lists`, `profiles`, or `taxa`  
#'
#' These (`galah`) versions all use lazy evaluation.
#' @returns description
#' @name tidyverse_functions
NULL

# @rdname tidyverse_functions
# @export
# between <- function(){}

#' @rdname tidyverse_functions
#' @param ... column to order by
#' @export
desc <- function(...){
  dots <- enquos(..., .ignore_empty = "all")
  parsed_dots <- parse_quosures_basic(dots)
  tibble(variable = parsed_dots,
         direction = "descending")
} 

#' @rdname tidyverse_functions
#' @export
unnest <- function(q_obj, error_call = caller_env()){
  if(!inherits(q_obj, "metadata_request")){
    abort("`galah::unnest` can only be used with objects of class `metadata_request`")
  }
  if(!is.null(q_obj$filter)){
    supplied_type <- q_obj$filter$variable[1]
    if(supplied_type != "taxa"){
      supplied_type <- paste0(supplied_type, "s")
    }
  }else if(!is.null(q_obj$identify)){
    supplied_type <- "taxa"
  }else{
    supplied_type <- q_obj$type
  }
  valid_types <- c("fields", "lists", "profiles", "taxa")
  if(!(supplied_type %in% valid_types)){
    bullets <- c(
      "Invalid `type` supplied to `unnest`",
      i = "valid types are `fields`, `lists`, `profiles` or `taxa`")
    abort(bullets, call = error_call)
  }
  q_obj$type <- paste0(supplied_type, "-unnest")
  q_obj
}
