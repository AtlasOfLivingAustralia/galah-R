#' Build a data request object
#' 
#' @param taxa `data.frame`: generated by a call to [search_taxa()]. This
#' argument also accepts a vector of unique species identifiers.
#' @param filter `data.frame`: generated by a call to [select_filters()]
#' @param geolocate `string`: generated by a call to [select_locations()]
#' @param select `data.frame`: generated by a call to [select_columns()]
#' @param ... other function-specific request parameters
#' @export
galah_call <- function(taxa = NULL, 
                       filter = NULL, 
                       select = NULL,
                       geolocate = NULL, 
                       group_by = NULL,
                       down_to = NULL,
                       ...){
  
  extra_args <- list(...)
  
  if(!is.null(taxa)){ check_taxa_arg(taxa) }
  check_call_args(filter, "filter")
  check_call_args(select, "select")
  check_call_args(geolocate, "geolocate")
  check_call_args(group_by, "group_by")
  check_call_args(down_to, "down_to")
  
  request <- structure(c(list(taxa = taxa,
                              select = select, 
                              filter = filter,
                              geolocate = geolocate,
                              group_by = group_by,
                              down_to = down_to),
                         extra_args),
                       class = "data_request")
  
  return(request)
}


check_call_args <- function(arg_supplied, arg_name){
  if(
    !is.null(arg_supplied) && 
    !inherits(arg_supplied, paste0("galah_", arg_name))
  ){
    abort(
      glue("`{arg_name}` argument requires an input generated by `galah_{arg_name}()`"),
      call = caller_env()
    )
  }
}


update_galah_call <- function(data_request, ...){
  dots <- list(...)
  result <- lapply(
    names(data_request), 
    function(a){
      if(any(names(dots) == a)){
        if(is.null(data_request[[a]])){
          dots[[a]]
        }else{
          rbind(data_request[[a]], dots[[a]])
        }
      }else{
        data_request[[a]]
      }
    })
  names(result) <- names(data_request)
  class(result) <- "data_request"
  result
}


#' @rdname galah_call
#' @export
print.data_request <- function(object){
  filled_slots <- !unlist(lapply(object, is.null))
  if(any(filled_slots)){
    cat("An object of type `data_request` containing:\n\n")
    print(as.list(object[filled_slots]))
    cat(paste0("...and ", length(object)-length(which(filled_slots)), " empty slots"))
  }else{
    cat("An empty object of type `data_request`")
  }
}